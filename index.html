<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .screen, .modal-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg">
        <!-- ===== LAYAR AUTENTIKASI ===== -->
        <div id="auth-screen" class="screen bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 space-y-5">
            <div class="text-center">
                <h1 id="auth-title" class="text-2xl md:text-3xl font-bold text-cyan-400">Login ke Akun Anda</h1>
                <p class="text-gray-400 mt-2">Kelola semua proyek Vercel Anda.</p>
            </div>
            <button id="google-login-button" class="w-full bg-white hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center transform hover:scale-105">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.345,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Lanjutkan dengan Google
            </button>
            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400 text-sm">ATAU</span><div class="flex-grow border-t border-gray-600"></div></div>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email-input" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500" placeholder="nama@email.com">
                <input type="password" id="password-input" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500" placeholder="••••••••">
                <button id="auth-button" type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition transform hover:scale-105 disabled:bg-cyan-800 disabled:cursor-not-allowed flex justify-center items-center"><span id="auth-button-text">Login</span></button>
            </form>
            <div id="auth-status" class="mt-4"></div>
            <p class="text-center text-sm text-gray-400"><span id="auth-toggle-text">Belum punya akun?</span> <a href="#" id="auth-toggle-link" class="font-medium text-cyan-400 hover:underline">Daftar di sini</a></p>
        </div>

        <!-- ===== LAYAR APLIKASI UTAMA ===== -->
        <div id="app-screen" class="screen bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 space-y-6 hidden">
             <div class="flex justify-between items-center border-b border-gray-700 pb-4">
                <div>
                     <h1 class="text-xl font-bold text-cyan-400">Project Manager</h1>
                     <p id="user-email-display" class="text-sm text-gray-400 flex items-center"></p>
                </div>
                <button id="logout-button" class="text-sm text-gray-400 hover:text-white transition">Logout</button>
            </div>
            
            <div id="status-container"></div>
            
            <div class="space-y-4">
                <select id="project-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 appearance-none"></select>
                <div id="project-info-container" class="text-sm bg-gray-700/50 p-3 rounded-lg hidden"></div>
                <div id="new-project-wrapper" class="hidden"><input type="text" id="new-project-name-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500" placeholder="nama-proyek-baru-keren"></div>
                <label class="w-full flex flex-col items-center justify-center p-4 bg-gray-700/50 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                    <svg class="w-8 h-8 text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span id="file-name" class="text-gray-400 text-center">Klik untuk memilih file HTML...</span>
                    <input id="file-upload" type="file" class="hidden" accept=".html">
                </label>
                <div id="analysis-button-container" class="text-center mt-2 hidden">
                    <button id="analyze-code-button" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition transform hover:scale-105">
                        ✨ Analisis Kode dengan Gemini
                    </button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-3 sm:space-y-0">
                <button id="deploy-button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition transform hover:scale-105 disabled:bg-cyan-800 flex justify-center items-center">
                    <span id="deploy-button-text">Deploy Sekarang</span>
                </button>
                <button id="delete-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-105 flex justify-center items-center hidden">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    Hapus Proyek
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL KONFIRMASI HAPUS -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
            <h3 class="text-lg font-medium text-white">Hapus Proyek</h3>
            <p class="mt-2 text-sm text-gray-400">Yakin ingin menghapus proyek <strong id="modal-project-name" class="font-bold text-red-400"></strong>? Tindakan ini tidak bisa dibatalkan.</p>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md transition">Batal</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md transition flex items-center">Ya, Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL ANALISIS KODE -->
    <div id="analysis-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
            <button id="modal-close-analysis" class="absolute top-3 right-4 text-2xl text-gray-400 hover:text-white">&times;</button>
            <h3 class="text-lg font-medium text-cyan-400 mb-4">✨ Analisis Kode Gemini</h3>
            <div id="analysis-result-container" class="text-sm text-gray-300 bg-gray-900/50 p-4 rounded-md h-64 overflow-y-auto" style="font-family: monospace; white-space: pre-wrap;">
                <!-- Hasil analisis akan muncul di sini -->
            </div>
        </div>
    </div>


    <!-- SPINNER ICON (untuk disisipkan via JS) -->
    <svg id="spinner-template" class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- KONFIGURASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyCx8eKTTDPzEjbmcCaQOop5zhgtzS6-5mM",
            authDomain: "vercel-ce99e.firebaseapp.com",
            projectId: "vercel-ce99e",
            storageBucket: "vercel-ce99e.appspot.com",
            messagingSenderId: "1077496685101",
            appId: "1:1077496685101:web:7dba4a28eaf78c74e5cea4",
        };
        const VERCEL_TOKEN = '7pnM52ywCbquEnhzRfvNNL3z'; // PERINGATAN: Tidak aman di frontend
        const SUPER_USER_EMAIL = 'akusky2298@gmail.com'; // FIX: Email sudah dibenarkan
        const SUPER_USER_PASS = 'gatauah123';
        const VERCEL_API_BASE = 'https://api.vercel.com';
        const GEMINI_API_KEY = ""; // Kunci API akan di-handle oleh environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;


        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // Elemen DOM
        const ui = {
            authScreen: document.getElementById('auth-screen'),
            appScreen: document.getElementById('app-screen'),
            authForm: document.getElementById('auth-form'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            authButton: document.getElementById('auth-button'),
            authButtonText: document.getElementById('auth-button-text'),
            authStatus: document.getElementById('auth-status'),
            authToggleLink: document.getElementById('auth-toggle-link'),
            authTitle: document.getElementById('auth-title'),
            authToggleText: document.getElementById('auth-toggle-text'),
            googleLoginButton: document.getElementById('google-login-button'),
            userEmailDisplay: document.getElementById('user-email-display'),
            logoutButton: document.getElementById('logout-button'),
            projectSelect: document.getElementById('project-select'),
            newProjectWrapper: document.getElementById('new-project-wrapper'),
            newProjectNameInput: document.getElementById('new-project-name-input'),
            fileUpload: document.getElementById('file-upload'),
            fileName: document.getElementById('file-name'),
            deployButton: document.getElementById('deploy-button'),
            deployButtonText: document.getElementById('deploy-button-text'),
            deleteButton: document.getElementById('delete-button'),
            statusContainer: document.getElementById('status-container'),
            projectInfoContainer: document.getElementById('project-info-container'),
            deleteModal: document.getElementById('delete-modal'),
            modalProjectName: document.getElementById('modal-project-name'),
            modalCancelButton: document.getElementById('modal-cancel-button'),
            modalConfirmButton: document.getElementById('modal-confirm-button'),
            spinnerTemplate: document.getElementById('spinner-template'),
            analysisModal: document.getElementById('analysis-modal'),
            modalCloseAnalysis: document.getElementById('modal-close-analysis'),
            analysisResultContainer: document.getElementById('analysis-result-container'),
            analyzeCodeButton: document.getElementById('analyze-code-button'),
            analysisButtonContainer: document.getElementById('analysis-button-container'),
        };
        
        let isLoginMode = true;
        let isSuperUser = false;

        // --- FUNGSI UTAMA ---

        onAuthStateChanged(auth, user => {
            if (user) {
                isSuperUser = user.email.toLowerCase() === SUPER_USER_EMAIL;
                ui.authScreen.classList.add('hidden');
                ui.appScreen.classList.remove('hidden');
                ui.userEmailDisplay.innerHTML = `${user.email} ${isSuperUser ? '<span class="ml-2 text-xs bg-cyan-500/20 text-cyan-400 px-2 py-1 rounded-full">Super User</span>' : ''}`;
                fetchAndDisplayProjects();
            } else {
                isSuperUser = false;
                ui.appScreen.classList.add('hidden');
                ui.authScreen.classList.remove('hidden');
            }
        });
        
        const fetchVercelAPI = async (endpoint, options = {}) => {
            const response = await fetch(`${VERCEL_API_BASE}${endpoint}`, {
                ...options,
                headers: { 'Authorization': `Bearer ${VERCEL_TOKEN}`, 'Content-Type': 'application/json', ...options.headers },
            });
            if (response.status === 204) return { success: true }; 
            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || `Error Vercel API: ${response.statusText}`);
            return data;
        };

        const fetchAndDisplayProjects = async () => {
            toggleLoading(ui.projectSelect, true);
            try {
                const data = await fetchVercelAPI('/v9/projects');
                populateProjectDropdown(data.projects);
            } catch (error) {
                showNotification(error.message, 'red', ui.statusContainer);
            } finally {
                toggleLoading(ui.projectSelect, false);
            }
        };

        const handleProjectSelectChange = async () => {
            const selectedProject = ui.projectSelect.value;
            const isNew = selectedProject === '__NEW__';
            ui.newProjectWrapper.classList.toggle('hidden', !isNew);
            ui.deleteButton.classList.toggle('hidden', isNew || !isSuperUser);
            ui.deployButtonText.textContent = isNew ? 'Deploy Proyek Baru' : 'Ganti & Deploy Ulang';
            
            if (isNew || !selectedProject) {
                ui.projectInfoContainer.classList.add('hidden');
                return;
            }

            ui.projectInfoContainer.innerHTML = 'Memuat info proyek...';
            ui.projectInfoContainer.classList.remove('hidden');
            try {
                const data = await fetchVercelAPI(`/v9/projects/${selectedProject}`);
                const prod = data.targets?.production;

                if (prod && prod.alias && prod.alias.length > 0) {
                    const domain = prod.alias[0];
                    const status = prod.readyState || 'UNKNOWN';
                    
                    let statusIndicator = '';
                    switch (status.toUpperCase()) {
                        case 'READY': statusIndicator = '<span class="flex items-center"><span class="h-2 w-2 rounded-full bg-green-500 mr-2"></span>Siap</span>'; break;
                        case 'BUILDING': statusIndicator = '<span class="flex items-center"><span class="h-2 w-2 rounded-full bg-yellow-500 mr-2"></span>Membangun</span>'; break;
                        case 'ERROR': statusIndicator = '<span class="flex items-center"><span class="h-2 w-2 rounded-full bg-red-500 mr-2"></span>Gagal</span>'; break;
                        default: statusIndicator = `<span class="flex items-center"><span class="h-2 w-2 rounded-full bg-gray-500 mr-2"></span>${status}</span>`;
                    }

                    ui.projectInfoContainer.innerHTML = `
                        <div class="flex justify-between items-center flex-wrap gap-2">
                            <div><strong>Domain:</strong> <a href="https://${domain}" target="_blank" class="underline text-cyan-400">${domain}</a></div>
                            <div><strong>Status:</strong> ${statusIndicator}</div>
                        </div>`;
                } else {
                     ui.projectInfoContainer.textContent = 'Proyek ini belum memiliki domain produksi.';
                }
            } catch (error) {
                ui.projectInfoContainer.innerHTML = '<strong>Info Proyek:</strong> Gagal memuat.';
            }
        };

        const handleDeploy = async () => {
            let projectName = ui.projectSelect.value;
            if (projectName === '__NEW__') projectName = ui.newProjectNameInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
            const file = ui.fileUpload.files[0];
            clearNotifications(ui.statusContainer);

            if (!projectName || !file) {
                showNotification('Nama proyek dan file harus diisi.', 'red', ui.statusContainer);
                return;
            }

            toggleLoading(ui.deployButton, true, ui.deployButtonText);
            try {
                const fileContent = await file.text();
                await fetchVercelAPI('/v13/deployments', {
                    method: 'POST',
                    body: JSON.stringify({ name: projectName, files: [{ file: file.name, data: fileContent }], projectSettings: { framework: null }, target: 'production' })
                });

                const baseDomain = `${projectName}.vercel.app`; 
                const uploadedFileName = file.name.toLowerCase();
                
                let finalUrl;
                if (uploadedFileName === 'index.html') {
                    finalUrl = `https://${baseDomain}`;
                } else {
                    finalUrl = `https://${baseDomain}/${file.name}`;
                }

                showNotification(`<strong>Deploy Berhasil!</strong><br>Proyek tayang di: <a href="${finalUrl}" target="_blank" class="underline font-bold">${finalUrl}</a>`, 'green', ui.statusContainer);
                
                setTimeout(() => {
                    fetchAndDisplayProjects().then(() => {
                        ui.projectSelect.value = projectName; 
                        handleProjectSelectChange();
                    });
                }, 2000);

            } catch (error) {
                showNotification(`Deployment Gagal: ${error.message}`, 'red', ui.statusContainer);
            } finally {
                toggleLoading(ui.deployButton, false, ui.deployButtonText);
            }
        };

        const handleDelete = async () => {
            const projectName = ui.projectSelect.value;
            if (!projectName || !isSuperUser) return;
            
            toggleLoading(ui.modalConfirmButton, true);
            try {
                await fetchVercelAPI(`/v9/projects/${projectName}`, { method: 'DELETE' });
                showNotification(`Proyek "${projectName}" berhasil dihapus.`, 'green', ui.statusContainer);
                await fetchAndDisplayProjects();
                handleProjectSelectChange();
            } catch(error) {
                showNotification(`Gagal menghapus proyek: ${error.message}`, 'red', ui.statusContainer);
            } finally {
                toggleLoading(ui.modalConfirmButton, false);
                ui.deleteModal.classList.add('hidden');
            }
        };
        
        const handleAuthSubmit = async (e) => {
            e.preventDefault();
            toggleLoading(ui.authButton, true, ui.authButtonText);
            clearNotifications(ui.authStatus);
            const email = ui.emailInput.value;
            const password = ui.passwordInput.value;

            try {
                if (email.toLowerCase() === SUPER_USER_EMAIL && password === SUPER_USER_PASS) {
                    try { await signInWithEmailAndPassword(auth, email, password); } 
                    catch (error) { if (['auth/user-not-found', 'auth/invalid-credential'].includes(error.code)) { await createUserWithEmailAndPassword(auth, email, password); } else { throw error; }}
                } else {
                     if (isLoginMode) { await signInWithEmailAndPassword(auth, email, password); } 
                     else { await createUserWithEmailAndPassword(auth, email, password); }
                }
            } catch (error) {
                showNotification(getFirebaseErrorMessage(error), 'red', ui.authStatus);
            } finally {
                toggleLoading(ui.authButton, false, ui.authButtonText);
            }
        };
        
        const handleCodeAnalysis = async () => {
            const file = ui.fileUpload.files[0];
            if (!file) {
                showNotification('Pilih file HTML terlebih dahulu.', 'red', ui.statusContainer);
                return;
            }

            ui.analysisResultContainer.innerHTML = `<div class="flex items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><span class="ml-4">Menganalisis kode...</span></div>`;
            ui.analysisModal.classList.remove('hidden');

            try {
                const htmlContent = await file.text();
                
                const systemPrompt = "Anda adalah seorang ahli pengembang web yang bertugas menganalisis kode HTML. Berikan ringkasan singkat dalam satu paragraf mengenai tujuannya. Kemudian, berikan tiga saran spesifik yang dapat ditindaklanjuti untuk meningkatkan SEO, aksesibilitas, atau performanya. Susun respons Anda PERSIS seperti berikut, menggunakan Markdown untuk format:\n\n**Ringkasan:**\n[Ringkasan Anda di sini]\n\n**Saran Peningkatan:**\n1. [Saran 1]\n2. [Saran 2]\n3. [Saran 3]";
                const userQuery = `Berikut adalah kode HTML untuk dianalisis:\n\n\`\`\`html\n${htmlContent}\n\`\`\``;

                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userQuery }] }],
                };
                
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error?.message || 'Gagal menghubungi Gemini API.');
                }

                const result = await response.json();
                let analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (analysisText) {
                    analysisText = analysisText
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-cyan-400">$1</strong>')
                        .replace(/\n/g, '<br>');
                    ui.analysisResultContainer.innerHTML = analysisText;
                } else {
                    throw new Error('Respons dari Gemini tidak valid.');
                }

            } catch (error) {
                ui.analysisResultContainer.innerHTML = `<span class="text-red-400">Terjadi kesalahan: ${error.message}</span>`;
            }
        };

        // --- FUNGSI BANTUAN (Helpers) ---

        const populateProjectDropdown = (projects) => {
            ui.projectSelect.innerHTML = '<option value="" disabled selected>Pilih Proyek...</option><option value="__NEW__">Buat Proyek Baru...</option>';
            projects.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => ui.projectSelect.add(new Option(p.name, p.name)));
        };
        
        const updateAuthUI = () => {
            clearNotifications(ui.authStatus);
            if (isLoginMode) {
                ui.authTitle.textContent = 'Login ke Akun Anda'; ui.authButtonText.textContent = 'Login';
                ui.authToggleText.textContent = 'Belum punya akun?'; ui.authToggleLink.textContent = 'Daftar di sini';
            } else {
                ui.authTitle.textContent = 'Buat Akun Baru'; ui.authButtonText.textContent = 'Daftar';
                ui.authToggleText.textContent = 'Sudah punya akun?'; ui.authToggleLink.textContent = 'Login di sini';
            }
        };

        const showNotification = (message, color, container) => {
            const colors = { green: 'bg-green-500/20 border-green-500 text-green-300', red: 'bg-red-500/20 border-red-500 text-red-300' };
            container.innerHTML = `<div class="p-4 rounded-lg border text-sm ${colors[color]}">${message}</div>`;
        };
        const clearNotifications = (container) => { container.innerHTML = ''; };

        const toggleLoading = (button, isLoading, textEl = null) => {
            button.disabled = isLoading;
            if (textEl) { textEl.classList.toggle('hidden', isLoading); }
            if (isLoading) {
                const spinner = ui.spinnerTemplate.cloneNode(true);
                spinner.removeAttribute('style'); spinner.removeAttribute('id');
                if (textEl) spinner.classList.add('mr-2');
                button.prepend(spinner);
            } else {
                const spinner = button.querySelector('.animate-spin');
                if (spinner) spinner.remove();
            }
        };
        
        const getFirebaseErrorMessage = (error) => {
            switch (error.code) {
                case 'auth/invalid-email': return 'Format email tidak valid.';
                case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return 'Email atau password salah.';
                case 'auth/email-already-in-use': return 'Email ini sudah terdaftar.';
                case 'auth/weak-password': return 'Password terlalu lemah (minimal 6 karakter).';
                default: return 'Terjadi kesalahan autentikasi. Coba lagi.';
            }
        };

        // --- EVENT LISTENERS ---
        ui.authForm.addEventListener('submit', handleAuthSubmit);
        ui.logoutButton.addEventListener('click', () => signOut(auth));
        ui.deployButton.addEventListener('click', handleDeploy);
        ui.projectSelect.addEventListener('change', handleProjectSelectChange);
        ui.deleteButton.addEventListener('click', () => {
            const projectName = ui.projectSelect.value;
            if (projectName) {
                ui.modalProjectName.textContent = projectName;
                ui.deleteModal.classList.remove('hidden');
            }
        });
        ui.modalCancelButton.addEventListener('click', () => ui.deleteModal.classList.add('hidden'));
        ui.modalConfirmButton.addEventListener('click', handleDelete);
        ui.fileUpload.addEventListener('change', () => {
             if (ui.fileUpload.files.length > 0) {
                ui.fileName.textContent = ui.fileUpload.files[0].name;
                ui.analysisButtonContainer.classList.remove('hidden');
            } else {
                ui.fileName.textContent = 'Klik untuk memilih file...';
                ui.analysisButtonContainer.classList.add('hidden');
            }
        });
        ui.authToggleLink.addEventListener('click', (e) => { e.preventDefault(); isLoginMode = !isLoginMode; updateAuthUI(); });
        ui.googleLoginButton.addEventListener('click', async () => {
            clearNotifications(ui.authStatus);
            try { await signInWithPopup(auth, googleProvider); } 
            catch (error) { showNotification(getFirebaseErrorMessage(error), 'red', ui.authStatus); }
        });
        ui.analyzeCodeButton.addEventListener('click', handleCodeAnalysis);
        ui.modalCloseAnalysis.addEventListener('click', () => ui.analysisModal.classList.add('hidden'));

    </script>
</body>
</html>

